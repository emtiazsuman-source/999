<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unified Admin - Cash & Tournament</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script defer src="/_vercel/insights/script.js"></script>
  
  <!-- Preload critical resources for admin panels -->
  <link rel="preload" href="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" as="script" crossorigin>
  <link rel="preload" href="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" as="script" crossorigin>
  <link rel="preload" href="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" as="script" crossorigin>
  
  
  <!-- DNS prefetch for external resources -->
  <link rel="dns-prefetch" href="//www.gstatic.com">
  <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
  <style>
    html, body { height: 100%; }
    body { background: #f0f2f5; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .app-h { height: calc(100vh - 24px); min-height: 600px; }
    @media (max-width: 1024px) { .hide-on-small { display: none; } }
    
    /* Preload animations and optimizations */
    iframe {
      will-change: transform;
      backface-visibility: hidden;
    }
    
    .preload-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      background: rgba(255, 255, 255, 0.9);
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    /* Iframe styling */
    iframe {
      position: relative;
    }
    
    /* Remove bottom-only view overlay */
    .bottom-only-view {
      display: none;
    }
  </style>
</head>
<body class="min-h-screen">
  <div id="loading" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center">
    <div class="animate-spin w-12 h-12 border-4 rounded-full border-pink-600 border-t-transparent"></div>
  </div>

  <header class="w-full bg-white shadow-sm border-b sticky top-0 z-40 hidden">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-full bg-pink-600 text-white flex items-center justify-center font-extrabold">CP</div>
        <div>
          <h1 class="text-lg font-bold text-gray-900">Unified Admin</h1>
          <p class="text-xs text-gray-500">Manage CashPoint & Tournament from one place</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="admin-name" class="text-sm text-gray-700"></span>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl px-3 py-3">
    <div class="grid grid-cols-12 gap-3 app-h">
      <!-- Left Sidebar -->
      <aside class="col-span-2 bg-white p-3 overflow-y-auto no-scrollbar flex flex-col">
        <div class="mb-3">
          <div class="text-xs uppercase text-gray-400 font-semibold mb-2">Navigation</div>
          <nav class="space-y-1">
            <button id="tab-cash" class="w-full text-left px-3 py-2 rounded-lg font-semibold bg-pink-50 text-pink-700">
              <i class="fa-solid fa-sack-dollar mr-2"></i> Cash Admin
            </button>
            <button id="tab-tournament" class="w-full text-left px-3 py-2 rounded-lg font-semibold text-gray-700 hover:bg-gray-50">
              <i class="fa-solid fa-trophy mr-2"></i> Tournament Admin
            </button>
            <button id="tab-user" class="w-full text-left px-3 py-2 rounded-lg font-semibold text-gray-700 hover:bg-gray-50">
              <i class="fa-solid fa-magnifying-glass mr-2"></i> User Search
            </button>
            <button id="tab-settings" class="w-full text-left px-3 py-2 rounded-lg font-semibold text-gray-700 hover:bg-gray-50">
              <i class="fa-solid fa-gear mr-2"></i> Admin Settings
            </button>
          </nav>
        </div>
        <div class="mt-4 hide-on-small">
          <div class="text-xs uppercase text-gray-400 font-semibold mb-2">Quick Actions</div>
          <div class="grid grid-cols-1 gap-2">
            <button id="reload-pane" class="w-full px-3 py-2 text-sm rounded-lg bg-gray-100 hover:bg-gray-200">
              <i class="fa-solid fa-rotate mr-2"></i> Reload Panel
            </button>
            <button id="open-new" class="w-full px-3 py-2 text-sm rounded-lg bg-gray-100 hover:bg-gray-200">
              <i class="fa-solid fa-arrow-up-right-from-square mr-2"></i> Open Current in New Tab
            </button>
          </div>
        </div>
        <div class="mt-5">
          <div class="text-xs uppercase text-gray-400 font-semibold mb-2">Cash Shortcuts</div>
          <div class="grid grid-cols-1 gap-2">
            <button id="cs-add" class="relative w-full px-3 py-2 text-sm rounded-lg bg-white hover:bg-gray-50 flex items-center"><i class="fa-solid fa-plus mr-2 text-pink-600"></i> অ্যাড মানি <span id="cs-badge-add" class="hidden absolute right-2 top-1/2 -translate-y-1/2 min-w-[22px] h-[22px] inline-flex items-center justify-center rounded-full bg-red-600 text-white text-[11px] px-1"></span></button>
            <button id="cs-transfer" class="relative w-full px-3 py-2 text-sm rounded-lg bg-white hover:bg-gray-50 flex items-center"><i class="fa-solid fa-paper-plane mr-2 text-pink-600"></i> ট্রান্সফার মানি <span id="cs-badge-transfer" class="hidden absolute right-2 top-1/2 -translate-y-1/2 min-w-[22px] h-[22px] inline-flex items-center justify-center rounded-full bg-red-600 text-white text-[11px] px-1"></span></button>
            <button id="cs-settings" class="w-full px-3 py-2 text-sm rounded-lg bg-white hover:bg-gray-50 flex items-center"><i class="fa-solid fa-gear mr-2 text-pink-600"></i> সেটিংস</button>
            <button id="cs-usersearch" class="w-full px-3 py-2 text-sm rounded-lg bg-white hover:bg-gray-50 flex items-center"><i class="fa-solid fa-magnifying-glass mr-2 text-pink-600"></i> ব্যবহারকারী সার্চ</button>
          </div>
        </div>
        
        <!-- Logout button moved to bottom -->
        <div class="mt-auto pt-4">
          <button id="logout-btn" class="w-full px-3 py-2 rounded-lg bg-red-600 text-white text-sm font-semibold hover:bg-red-700 flex items-center justify-center">
            <i class="fa-solid fa-right-from-bracket mr-2"></i> লগআউট
          </button>
        </div>
      </aside>

      <!-- Main Content -->
      <section class="col-span-10 flex flex-col bg-white">
        <div class="flex items-center justify-between px-3 py-2 bg-gray-50 hidden">
          <div class="flex items-center gap-2">
            <button id="tabbtn-cash" class="px-3 py-1.5 rounded-md text-sm font-semibold bg-pink-600 text-white">Cash Admin</button>
            <button id="tabbtn-tournament" class="px-3 py-1.5 rounded-md text-sm font-semibold text-gray-700 hover:bg-gray-100">Tournament Admin</button>
          </div>
          <div class="flex items-center gap-2">
            <span id="status-text" class="text-xs text-gray-500">Ready</span>
          </div>
        </div>
        <div class="relative flex-1 h-full">
          <!-- Cash Admin Panel (Standalone) -->
          <div id="fallback-cash" class="absolute inset-0 w-full h-full overflow-y-auto p-3 no-scrollbar">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-bold text-gray-800">Cash Admin</h2>
              <button id="fb-refresh-cash" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-md text-sm border"><i class="fa-solid fa-rotate mr-2"></i>Refresh</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
              <div class="bg-white border rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="font-semibold text-gray-800">Pending Add Money</h3>
                  <span id="fb-count-add" class="text-xs text-gray-500">0</span>
                </div>
                <div id="fb-list-add" class="space-y-2"></div>
              </div>
              <div class="bg-white border rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="font-semibold text-gray-800">Pending Transfers</h3>
                  <span id="fb-count-transfer" class="text-xs text-gray-500">0</span>
                </div>
                <div id="fb-list-transfer" class="space-y-2"></div>
              </div>
            </div>
          </div>

          <!-- Tournament Admin Panel (Standalone) -->
          <div id="fallback-tournament" class="absolute inset-0 w-full h-full overflow-y-auto p-3 no-scrollbar hidden">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-bold text-gray-800">Tournament Admin</h2>
              <button id="fb-refresh-t" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-md text-sm border"><i class="fa-solid fa-rotate mr-2"></i>Refresh</button>
            </div>
            <div id="fb-posts" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3"></div>
          </div>

          <!-- User Search Panel -->
          <div id="panel-user" class="absolute inset-0 w-full h-full overflow-y-auto p-3 no-scrollbar hidden">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-bold text-gray-800">User Search</h2>
            </div>
            <div class="space-y-3">
              <div class="grid grid-cols-1 gap-2">
                <div class="flex items-center gap-2">
                  <input type="text" id="user-search-input" placeholder="UserID / ইমেইল / মোবাইল / নাম" class="flex-1 p-2 border border-gray-300 rounded-md focus:ring-pink-600 focus:border-pink-600">
                  <select id="user-search-field" class="p-2 border border-gray-300 rounded-md">
                    <option value="auto">Auto</option>
                    <option value="uid">User ID</option>
                    <option value="email">ইমেইল</option>
                    <option value="mobile">মোবাইল</option>
                    <option value="name">নাম</option>
                  </select>
                  <button id="user-search-btn" class="py-2 px-3 bg-pink-600 text-white rounded-md font-semibold">সার্চ</button>
                </div>
                <p class="text-xs text-gray-500">নোট: নাম দিয়ে সার্চ করলে শুরু অংশ মিলিয়ে ফলাফল দেখাবে। অন্যগুলোতে একদম সঠিক মিল প্রয়োজন।</p>
              </div>
              <div id="user-search-results" class="space-y-2"></div>
            </div>
          </div>

          <!-- Admin Settings Panel -->
          <div id="panel-settings" class="absolute inset-0 w-full h-full overflow-y-auto p-3 no-scrollbar hidden">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-bold text-gray-800">Admin Settings</h2>
              <div class="flex items-center gap-2">
                <button id="settings-refresh" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-md text-sm border">Refresh</button>
                <button id="settings-save" class="px-3 py-1.5 bg-pink-600 hover:bg-pink-700 text-white rounded-md text-sm">Save</button>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div class="bg-white border rounded-lg p-3 space-y-2">
                <h3 class="font-semibold text-gray-800">Charges</h3>
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <label class="text-xs text-gray-500">Send %</label>
                    <input id="set-send-perc" type="number" step="0.01" class="w-full p-2 border rounded" />
                  </div>
                  <div>
                    <label class="text-xs text-gray-500">Send Fixed</label>
                    <input id="set-send-fixed" type="number" step="0.01" class="w-full p-2 border rounded" />
                  </div>
                  <div>
                    <label class="text-xs text-gray-500">Transfer %</label>
                    <input id="set-transfer-perc" type="number" step="0.01" class="w-full p-2 border rounded" />
                  </div>
                  <div>
                    <label class="text-xs text-gray-500">Transfer Fixed</label>
                    <input id="set-transfer-fixed" type="number" step="0.01" class="w-full p-2 border rounded" />
                  </div>
                </div>
              </div>
              <div class="bg-white border rounded-lg p-3 space-y-2">
                <h3 class="font-semibold text-gray-800">Reserves</h3>
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <label class="text-xs text-gray-500">bKash Reserve</label>
                    <input id="set-res-bkash" type="number" step="0.01" class="w-full p-2 border rounded" />
                  </div>
                  <div>
                    <label class="text-xs text-gray-500">Nagad Reserve</label>
                    <input id="set-res-nagad" type="number" step="0.01" class="w-full p-2 border rounded" />
                  </div>
                </div>
                <h3 class="font-semibold text-gray-800 mt-2">Payment Numbers</h3>
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <label class="text-xs text-gray-500">bKash Number</label>
                    <input id="set-pay-bkash" type="text" class="w-full p-2 border rounded" />
                  </div>
                  <div>
                    <label class="text-xs text-gray-500">Nagad Number</label>
                    <input id="set-pay-nagad" type="text" class="w-full p-2 border rounded" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Right Panel (Optional info) -->
      <aside class="col-span-2 bg-white rounded-xl shadow-sm border p-3 overflow-y-auto no-scrollbar hide-on-small hidden">
        <div class="text-xs uppercase text-gray-400 font-semibold mb-2">Info</div>
        <div class="space-y-2 text-sm text-gray-700">
          <p>Use the tabs to switch between Cash and Tournament admin panels.</p>
          <p>Both panels are loaded securely within this unified dashboard.</p>
        </div>
      </aside>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, getDocs, collection, query, where, orderBy, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCb9v4Q8XsaBKpnopMHE_5_aXEEMkEQork",
      authDomain: "cashpoint-f8b51.firebaseapp.com",
      projectId: "cashpoint-f8b51",
      storageBucket: "cashpoint-f8b51.firebasestorage.app",
      messagingSenderId: "50891144664",
      appId: "1:50891144664:web:e90f63977c95c86c04c6ad",
      measurementId: "G-WJXSMFBEE6"
    };
    const appId = "cashpoint-f8b51";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Register Service Worker for caching
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/admin-sw.js')
          .then((registration) => {
            console.log('Admin SW registered:', registration);
          })
          .catch((error) => {
            console.log('Admin SW registration failed:', error);
          });
      });
    }

    const loading = document.getElementById('loading');
    const logoutBtn = document.getElementById('logout-btn');
    const adminNameEl = document.getElementById('admin-name');
    const tabCash = document.getElementById('tab-cash');
    const tabTournament = document.getElementById('tab-tournament');
    const tabUser = document.getElementById('tab-user');
    const tabSettings = document.getElementById('tab-settings');
    const tabBtnCash = document.getElementById('tabbtn-cash');
    const tabBtnTournament = document.getElementById('tabbtn-tournament');
    const reloadBtn = document.getElementById('reload-pane');
    const openNewBtn = document.getElementById('open-new');
    const statusText = document.getElementById('status-text');
    // Cash shortcuts
    const csAdd = document.getElementById('cs-add');
    const csTransfer = document.getElementById('cs-transfer');
    const csSettings = document.getElementById('cs-settings');
    const csUserSearch = document.getElementById('cs-usersearch');

    function setTab(active) {
      const cashActive = active === 'cash';
      // Sidebar state
      tabCash.classList.toggle('bg-pink-50', cashActive);
      tabCash.classList.toggle('text-pink-700', cashActive);
      tabCash.classList.toggle('border-pink-200', cashActive);
      const tournamentActive = active === 'tournament';
      tabTournament.classList.toggle('bg-pink-50', tournamentActive);
      tabTournament.classList.toggle('text-pink-700', tournamentActive);
      tabTournament.classList.toggle('border-pink-200', tournamentActive);
      const userActive = active === 'user';
      tabUser.classList.toggle('bg-pink-50', userActive);
      tabUser.classList.toggle('text-pink-700', userActive);
      tabUser.classList.toggle('border-pink-200', userActive);
      const settingsActive = active === 'settings';
      tabSettings.classList.toggle('bg-pink-50', settingsActive);
      tabSettings.classList.toggle('text-pink-700', settingsActive);
      tabSettings.classList.toggle('border-pink-200', settingsActive);
      // Top tabs
      tabBtnCash.classList.toggle('bg-pink-600', cashActive);
      tabBtnCash.classList.toggle('text-white', cashActive);
      tabBtnCash.classList.toggle('text-gray-700', !cashActive);
      tabBtnCash.classList.toggle('hover:bg-gray-100', !cashActive);
      tabBtnTournament.classList.toggle('bg-pink-600', tournamentActive);
      tabBtnTournament.classList.toggle('text-white', tournamentActive);
      tabBtnTournament.classList.toggle('text-gray-700', !tournamentActive);
      tabBtnTournament.classList.toggle('hover:bg-gray-100', !tournamentActive);
      // Panels
      document.getElementById('fallback-cash').classList.toggle('hidden', !cashActive);
      document.getElementById('fallback-tournament').classList.toggle('hidden', !tournamentActive);
      document.getElementById('panel-user').classList.toggle('hidden', !userActive);
      document.getElementById('panel-settings').classList.toggle('hidden', !settingsActive);
      statusText.textContent = cashActive ? 'Cash Admin active' : tournamentActive ? 'Tournament Admin active' : userActive ? 'User Search active' : 'Admin Settings active';
    }

    function reloadCurrent() {
      const activeIsCash = !document.getElementById('fallback-cash').classList.contains('hidden');
      if (activeIsCash) loadCashFallback(); else loadTournamentFallback();
    }

    function openCurrentInNew() {
      window.open(window.location.href, '_blank');
    }

    tabCash.addEventListener('click', () => setTab('cash'));
    tabTournament.addEventListener('click', () => setTab('tournament'));
    tabUser.addEventListener('click', () => setTab('user'));
    tabSettings.addEventListener('click', () => setTab('settings'));
    tabBtnCash.addEventListener('click', () => setTab('cash'));
    tabBtnTournament.addEventListener('click', () => setTab('tournament'));
    reloadBtn.addEventListener('click', reloadCurrent);
    openNewBtn.addEventListener('click', openCurrentInNew);
    logoutBtn.addEventListener('click', async () => { try { await signOut(auth); } finally { window.location.href = '/login'; } });
    

    // ---------- Helpers: Modal & Copy ----------
    function openModal(id, title, bodyHtml) {
      let wrap = document.getElementById(id);
      if (wrap) wrap.remove();
      const html = `
        <div id="${id}" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 p-4">
          <div class="w-full max-w-4xl bg-white rounded-xl shadow-xl overflow-hidden">
            <div class="flex items-center justify-between px-4 py-3 border-b">
              <h3 class="text-lg font-semibold text-gray-900">${title}</h3>
              <button class="text-gray-500 hover:text-gray-700" data-close><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-4 max-h-[70vh] overflow-y-auto no-scrollbar">${bodyHtml}</div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', html);
      const el = document.getElementById(id);
      el.addEventListener('click', (e) => { if (e.target === el || e.target.closest('[data-close]')) el.remove(); });
    }
    function copyText(text) { navigator.clipboard.writeText(text).catch(() => {}); }

    function isCashPanelActive() { return !document.getElementById('fallback-cash').classList.contains('hidden'); }
    function scrollInto(el) { if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }

    // Cash Shortcuts handlers
    function handleShortcut(type) {
      setTab('cash');
      // Scroll to sections or show info
      if (type === 'add') scrollInto(document.getElementById('fb-list-add'));
      else if (type === 'transfer') scrollInto(document.getElementById('fb-list-transfer'));
      else if (type === 'settings') openModal('infoM', 'সেটিংস', '<div class="p-2">এই ভিউতে সেটিংস কনফিগ সংযুক্ত করা হয়নি।</div>');
      else if (type === 'user') openModal('infoM', 'ব্যবহারকারী সার্চ', '<div class="p-2">এই ভিউতে ব্যবহারকারী সার্চ সংযুক্ত করা হয়নি।</div>');
    }

    if (csAdd) csAdd.addEventListener('click', () => handleShortcut('add'));
    if (csTransfer) csTransfer.addEventListener('click', () => handleShortcut('transfer'));
    if (csSettings) csSettings.addEventListener('click', () => handleShortcut('settings'));
    if (csUserSearch) csUserSearch.addEventListener('click', () => handleShortcut('user'));

    // ---------- Fallback renderers ----------
    // Real-time pending badges on sidebar
    let unsubAddPending = null;
    let unsubTransferPending = null;
    function subscribeSidebarBadges() {
      const badgeAdd = document.getElementById('cs-badge-add');
      const badgeTransfer = document.getElementById('cs-badge-transfer');
      const setBadge = (el, count) => {
        if (!el) return;
        el.dataset.count = String(count);
        if (count > 0) { el.textContent = count > 99 ? '99+' : String(count); el.classList.remove('hidden'); }
        else { el.textContent = ''; el.classList.add('hidden'); }
      };
      try { if (unsubAddPending) unsubAddPending(); } catch {}
      try { if (unsubTransferPending) unsubTransferPending(); } catch {}
      const addCol = collection(db, `artifacts/${appId}/add_money_requests`);
      const transferCol = collection(db, `artifacts/${appId}/money_transfer_requests`);
      unsubAddPending = onSnapshot(query(addCol, where('status','==','pending')), (snap) => setBadge(badgeAdd, snap.size));
      unsubTransferPending = onSnapshot(query(transferCol, where('status','==','pending')), (snap) => setBadge(badgeTransfer, snap.size));
    }
    function unsubscribeSidebarBadges(){ try { if (unsubAddPending) unsubAddPending(); } catch {}; try { if (unsubTransferPending) unsubTransferPending(); } catch {}; }
    // Route availability checks and iframe toggles removed — standalone panels are always used

    // Cash fallback: load pending add money and transfers
    async function loadCashFallback() {
      const addWrap = document.getElementById('fb-list-add');
      const trWrap = document.getElementById('fb-list-transfer');
      addWrap.innerHTML = '<div class="text-center text-gray-500 p-4">Loading...</div>';
      trWrap.innerHTML = '<div class="text-center text-gray-500 p-4">Loading...</div>';
      try {
        const addSnap = await getDocs(query(collection(db, `artifacts/${appId}/add_money_requests`), where('status','==','pending')));
        const trSnap = await getDocs(query(collection(db, `artifacts/${appId}/money_transfer_requests`), where('status','==','pending')));
        document.getElementById('fb-count-add').textContent = String(addSnap.size);
        document.getElementById('fb-count-transfer').textContent = String(trSnap.size);
        const toRow = (d, type) => {
          const data = d.data();
          const amount = Number(data.amount || 0).toFixed(2);
          const uid = data.userId || data.uid || 'N/A';
          const createdAt = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleString() : '';
          return `
            <div class="p-3 bg-white border rounded-lg flex items-center justify-between gap-3">
              <div class="min-w-0">
                <p class="font-semibold text-gray-800">৳ ${amount}</p>
                <p class="text-xs text-gray-500">UID: <span class="font-mono">${uid}</span></p>
                <p class="text-[11px] text-gray-400">${createdAt}</p>
              </div>
              <div class="flex items-center gap-2">
                <button class="px-2 py-1 text-xs rounded bg-green-600 text-white" data-approve data-type="${type}" data-id="${d.id}">Approve</button>
                <button class="px-2 py-1 text-xs rounded bg-red-600 text-white" data-reject data-type="${type}" data-id="${d.id}">Reject</button>
              </div>
            </div>`;
        };
        addWrap.innerHTML = addSnap.size ? addSnap.docs.map(d => toRow(d,'add')).join('') : '<div class="text-center text-gray-400 p-4">No pending add requests</div>';
        trWrap.innerHTML = trSnap.size ? trSnap.docs.map(d => toRow(d,'transfer')).join('') : '<div class="text-center text-gray-400 p-4">No pending transfers</div>';
        // Wire actions
        document.querySelectorAll('[data-approve],[data-reject]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const el = e.currentTarget;
            const type = el.dataset.type;
            const id = el.dataset.id;
            const col = type === 'add' ? 'add_money_requests' : 'money_transfer_requests';
            const ref = doc(db, `artifacts/${appId}/${col}/${id}`);
            const status = el.hasAttribute('data-approve') ? 'approved' : 'rejected';
            try { await updateDoc(ref, { status }); loadCashFallback(); } catch { /* ignore */ }
          });
        });
      } catch (_) {
        addWrap.innerHTML = '<div class="text-center text-red-500 p-4">Failed to load</div>';
        trWrap.innerHTML = '<div class="text-center text-red-500 p-4">Failed to load</div>';
      }
    }

    // Tournament fallback: list posts and provide User+ID / Only ID list
    async function loadTournamentFallback() {
      const postsEl = document.getElementById('fb-posts');
      postsEl.innerHTML = '<div class="text-center text-gray-500 p-4">Loading...</div>';
      try {
        const postsCol = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
        const snap = await getDocs(query(postsCol, orderBy('startTime','asc')));
        if (!snap.size) { postsEl.innerHTML = '<div class="text-center text-gray-400 p-4">No tournaments</div>'; return; }
        const card = (p) => {
          const d = p.data();
          const title = d.title || 'Tournament';
          const start = d.startTime && d.startTime.toDate ? d.startTime.toDate().toLocaleString() : '';
          return `
            <div class="border rounded-lg p-3 bg-white">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-semibold text-gray-900">${title}</h3>
                  <p class="text-xs text-gray-500">${start}</p>
                </div>
                <div class="flex items-center gap-2">
                  <button class="px-2 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700" data-view-players data-id="${p.id}"><i class="fa-solid fa-users mr-1"></i>প্লেয়ার দেখুন</button>
                  <button class="px-2 py-1 text-xs rounded bg-gray-100 border hover:bg-gray-200" data-userid-list data-id="${p.id}"><i class="fa-solid fa-list-ol mr-1"></i>User + ID</button>
                  <button class="px-2 py-1 text-xs rounded bg-gray-100 border hover:bg-gray-200" data-onlyid-list data-id="${p.id}"><i class="fa-solid fa-list mr-1"></i>Only ID</button>
                </div>
              </div>
            </div>`;
        };
        postsEl.innerHTML = snap.docs.map(card).join('');
        postsEl.querySelectorAll('[data-view-players]').forEach(btn => btn.addEventListener('click', () => openListModal(btn.dataset.id, true)));
        postsEl.querySelectorAll('[data-userid-list]').forEach(btn => btn.addEventListener('click', () => openListModal(btn.dataset.id, true)));
        postsEl.querySelectorAll('[data-onlyid-list]').forEach(btn => btn.addEventListener('click', () => openListModal(btn.dataset.id, false)));
      } catch (_) {
        postsEl.innerHTML = '<div class="text-center text-red-500 p-4">Failed to load tournaments</div>';
      }
    }

    async function openListModal(postId, includeNames) {
      try {
        const partCol = collection(db, 'artifacts', appId, 'public', 'data', 'posts', postId, 'participants');
        const snap = await getDocs(query(partCol, orderBy('joinedAt','asc')));
        let grid = '<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">';
        let textOut = '';
        let i = 0;
        for (const d of snap.docs) {
          i += 1;
          const pdata = d.data() || {};
          const name = pdata.fullName || 'Unknown';
          const ids = pdata.idValues || {};
          const idHtml = Object.values(ids).map(v => `<p class=\"font-mono text-blue-700 text-sm break-all\">${v}</p>`).join('');
          const title = includeNames ? `<h4 class=\"font-semibold text-gray-900 truncate\">${name}</h4>` : '';
          grid += `
            <div class=\"border rounded-lg p-3 bg-white\">
              <div class=\"flex items-center gap-3\">
                <span class=\"px-2 py-0.5 text-xs bg-slate-100 rounded font-bold text-slate-700\">${i}.</span>
                ${title}
              </div>
              <div class=\"${includeNames ? 'pl-11 mt-2 pt-2 border-t border-slate-200' : 'mt-2'} space-y-1\">${idHtml || '<p class=\\"text-xs text-gray-400\\">No info.</p>'}</div>
            </div>`;
          const idLines = Object.values(ids).map(v => `- ${v}`).join('\n');
          textOut += includeNames ? `${i}. - ${name}\n${idLines}\n\n` : `${i}.\n${idLines}\n\n`;
        }
        grid += '</div>';
        const body = `
          <div class=\"space-y-4\">
            ${grid}
            <div class=\"flex gap-2 pt-4 border-t\">
              <button id=\"mdl-copy\" class=\"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold flex items-center justify-center gap-2\"><i class=\"fa-solid fa-copy\"></i> কপি</button>
            </div>
          </div>`;
        openModal('listModal', includeNames ? 'User + ID List' : 'Only ID List', body);
        setTimeout(() => {
          const btn = document.getElementById('mdl-copy');
          if (btn) btn.addEventListener('click', () => copyText(textOut.trim()));
        }, 0);
      } catch (_) {
        openModal('listModal', 'Error', '<div class="text-red-600">Failed to load list.</div>');
      }
    }

    // ---------- User Search panel ----------
    function initUserSearchPanel() {
      const input = document.getElementById('user-search-input');
      const btn = document.getElementById('user-search-btn');
      const fieldSel = document.getElementById('user-search-field');
      const resultsEl = document.getElementById('user-search-results');
      if (!input || !btn || !fieldSel || !resultsEl) return;
      const doSearch = async () => {
        const termRaw = (input.value || '').trim();
        resultsEl.innerHTML = '<div class="text-center p-4 text-gray-500">সার্চ হচ্ছে...</div>';
        if (!termRaw) { resultsEl.innerHTML = '<div class="text-center p-4 text-gray-500">অনুগ্রহ করে সার্চ টেক্সট লিখুন।</div>'; return; }
        try {
          let users = [];
          const usersCol = collection(db, `artifacts/${appId}/users`);
          const addUserDoc = (id, data) => { users.push({ id, ...data }); };
          const autoDetect = () => {
            if (termRaw.includes('@')) return 'email';
            if (/^\d{10,15}$/.test(termRaw)) return 'mobile';
            if (/^[A-Za-z0-9_-]{20,}$/.test(termRaw)) return 'uid';
            return 'name';
          };
          const field = fieldSel.value;
          const mode = field === 'auto' ? autoDetect() : field;
          if (mode === 'uid') {
            const snap = await getDoc(doc(db, `artifacts/${appId}/users/${termRaw}`));
            if (snap.exists()) addUserDoc(snap.id, snap.data());
          } else if (mode === 'email') {
            const qy = query(usersCol, where('email', '==', termRaw));
            const snap = await getDocs(qy);
            snap.forEach(d => addUserDoc(d.id, d.data()));
          } else if (mode === 'mobile') {
            const qy = query(usersCol, where('mobile', '==', termRaw));
            const snap = await getDocs(qy);
            snap.forEach(d => addUserDoc(d.id, d.data()));
          } else if (mode === 'name') {
            const start = termRaw;
            const end = termRaw + '\uf8ff';
            try {
              const qy = query(usersCol, orderBy('fullName'), startAt(start), endAt(end), limit(25));
              const snap = await getDocs(qy);
              snap.forEach(d => addUserDoc(d.id, d.data()));
            } catch (e) {
              const qy2 = query(usersCol, where('fullName', '==', termRaw));
              const snap2 = await getDocs(qy2);
              snap2.forEach(d => addUserDoc(d.id, d.data()));
            }
          }
          resultsEl.innerHTML = '';
          if (users.length === 0) { resultsEl.innerHTML = '<div class="text-center p-4 text-gray-500">কোনো ফলাফল পাওয়া যায়নি।</div>'; return; }
          users.forEach(u => {
            const row = document.createElement('div');
            row.className = 'flex items-center justify-between p-3 bg-white rounded-lg shadow-sm';
            const left = document.createElement('div');
            left.className = 'min-w-0';
            left.innerHTML = `
              <p class="font-semibold text-gray-800 truncate cursor-pointer hover:underline" title="প্রোফাইল দেখুন">${u.fullName || 'Unknown'}</p>
              <p class="text-xs text-gray-500">মোবাইল: ${u.mobile || 'N/A'}</p>
              <p class="text-[10px] text-gray-400 font-mono truncate">UID: ${u.id}</p>`;
            const right = document.createElement('div');
            right.className = 'text-right';
            right.innerHTML = `
              <p class="text-sm font-bold text-gray-800">৳ ${(u.balance || 0).toFixed(2)}</p>
              <button class="mt-1 py-1 px-2 text-xs bg-pink-600 text-white rounded" data-uid="${u.id}">প্রোফাইল</button>`;
            left.querySelector('p.font-semibold').addEventListener('click', (e) => { e.stopPropagation(); showUserProfileModal(u.id); });
            right.querySelector('button').addEventListener('click', (e) => { e.stopPropagation(); showUserProfileModal(u.id); });
            row.append(left, right);
            resultsEl.appendChild(row);
          });
        } catch (err) {
          console.error('User search failed:', err);
          resultsEl.innerHTML = '<div class="text-center p-4 text-red-500">সার্চ করতে সমস্যা হয়েছে।</div>';
        }
      };
      btn.addEventListener('click', doSearch);
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); });
    }

    // ---------- Profile modal + balance adjust ----------
    async function adjustUserBalance(userId, amount, isCredit, note) {
      const userRef = doc(db, `artifacts/${appId}/users/${userId}`);
      const delta = isCredit ? amount : -amount;
      await updateDoc(userRef, { balance: increment(delta) });
      const txRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
      const transactionId = (function(){ const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let r=''; for(let i=0;i<9;i++){ r+=chars.charAt(Math.floor(Math.random()*chars.length)); } return r; })();
      await addDoc(txRef, { type: 'admin_adjust', status: 'success', amount: delta, description: `${isCredit ? 'Admin Credit' : 'Admin Debit'}${note ? ' - ' + note : ''}`, transactionId, timestamp: serverTimestamp() });
    }

    async function showUserProfileModal(userId) {
      try {
        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
        const userDoc = await getDoc(userDocRef);
        if (!userDoc.exists()) { openModal('userProfile', 'Error', '<div class="text-red-600">ইউজার পাওয়া যায়নি</div>'); return; }
        const user = userDoc.data();
        const txColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
        const txSnap = await getDocs(txColRef);
        const txs = txSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        txs.sort((a,b)=>{ const ta=a.timestamp&&a.timestamp.toDate? a.timestamp.toDate().getTime():0; const tb=b.timestamp&&b.timestamp.toDate? b.timestamp.toDate().getTime():0; return tb-ta; });
        let listHtml = '';
        if (txs.length===0) { listHtml = '<p class="text-sm text-gray-500">কোনো ট্রানজেকশন নেই।</p>'; }
        else {
          listHtml = txs.map(tx => {
            let statusText='সফল', statusClass='text-green-600';
            if (tx.status==='pending') { statusText='অপেক্ষমাণ'; statusClass='text-orange-500'; }
            else if (tx.status==='rejected') { statusText='ব্যর্থ'; statusClass='text-red-600'; }
            const date = tx.timestamp && tx.timestamp.toDate ? tx.timestamp.toDate() : new Date();
            const time = date.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true});
            const dateStr = date.toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'2-digit'});
            const amountVal = typeof tx.amount==='number'? Math.abs(tx.amount).toFixed(2):'0.00';
            let prefix = (tx.amount||0) >= 0 ? '+ ৳' : '- ৳';
            let color = (tx.amount||0) >= 0 ? 'text-green-600' : 'text-red-600';
            const trxId = tx.transactionId || tx.txId || tx.reference || tx.id || 'N/A';
            return `
              <div class="flex items-center p-3 bg-white rounded-lg shadow-sm">
                <div class="flex-grow">
                  <p class="font-semibold text-gray-800">${tx.type || 'লেনদেন'}</p>
                  <p class="text-xs text-gray-500">TrxID: ${trxId}</p>
                  <p class="text-xs font-semibold ${statusClass}">${statusText}</p>
                </div>
                <div class="text-right">
                  <p class="font-bold ${color}">${prefix}${amountVal}</p>
                  <p class="text-xs text-gray-400">${time} ${dateStr}</p>
                </div>
              </div>`;
          }).join('');
        }
        const body = `
          <div class="space-y-3">
            <div class="bg-gray-50 rounded-lg p-3">
              <p class="text-sm text-gray-700"><span class="font-semibold">নাম:</span> ${user.fullName || 'N/A'}</p>
              <p class="text-sm text-gray-700"><span class="font-semibold">মোবাইল:</span> ${user.mobile || 'N/A'}</p>
              <p class="text-sm text-gray-700"><span class="font-semibold">ইউজার আইডি:</span> <span class="font-mono">${userId}</span></p>
              <p class="text-sm text-gray-700 flex items-center gap-2">
                <span class="font-semibold">ব্যালেন্স:</span>
                <span id="profile-balance-value">৳ ${(user.balance || 0).toFixed(2)}</span>
              </p>
            </div>
            <div class="bg-white rounded-lg p-3 border">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-sm font-semibold text-gray-800">ব্যালেন্স এডজাস্ট (অ্যাড/ডেবিট)</h4>
              </div>
              <div class="grid grid-cols-1 gap-2">
                <div class="flex items-center gap-2">
                  <select id="adj-type" class="px-2 py-1 border rounded-md text-sm">
                    <option value="credit">ক্রেডিট (+)</option>
                    <option value="debit">ডেবিট (-)</option>
                  </select>
                  <input id="adj-amount" type="number" step="0.01" min="0" placeholder="পরিমাণ" class="flex-1 px-2 py-1 border rounded-md text-sm" />
                </div>
                <input id="adj-note" type="text" placeholder="নোট (ঐচ্ছিক)" class="px-2 py-1 border rounded-md text-sm" />
                <button id="adj-submit" class="px-3 py-2 bg-pink-600 text-white rounded-md text-sm">আপডেট করুন</button>
                <p class="text-[12px] text-gray-500">এই এডজাস্টমেন্টটি ট্রানজেকশন হিস্টরিতে "admin_adjust" হিসেবে সংরক্ষণ হবে।</p>
              </div>
            </div>
            <h4 class="text-md font-semibold text-gray-800">সকল ট্রানজেকশন</h4>
            <div class="max-h-96 overflow-y-auto space-y-2">${listHtml}</div>
          </div>`;
        openModal('userProfile', 'প্রোফাইল ও স্টেটমেন্ট', body);
        setTimeout(() => {
          const adjBtn = document.getElementById('adj-submit');
          if (adjBtn) {
            adjBtn.addEventListener('click', async () => {
              const type = (document.getElementById('adj-type')).value;
              const amtStr = (document.getElementById('adj-amount')).value;
              const note = (document.getElementById('adj-note')).value?.trim() || '';
              const amount = Number(amtStr);
              if (!amtStr || isNaN(amount) || amount <= 0) { return; }
              try {
                await adjustUserBalance(userId, amount, type === 'credit', note);
                const balValueEl = document.getElementById('profile-balance-value');
                const cur = Number((user.balance || 0));
                const delta = type === 'credit' ? amount : -amount;
                const next = (cur + delta).toFixed(2);
                if (balValueEl) balValueEl.textContent = `৳ ${next}`;
                user.balance = Number(next);
              } catch (e) {
                console.error(e);
              }
            });
          }
        }, 0);
      } catch (e) {
        console.error('Failed to load user profile:', e);
        openModal('userProfile', 'Error', '<div class="text-red-600">ইউজার প্রোফাইল লোড করতে সমস্যা হয়েছে।</div>');
      }
    }

    // ---------- Admin Settings panel ----------
    async function loadSettings() {
      const ref = doc(db, `artifacts/${appId}/admin_config/settings`);
      const snap = await getDoc(ref);
      const data = snap.exists() ? snap.data() : {};
      const val = (p, d) => p !== undefined ? p : d;
      (document.getElementById('set-send-perc')).value = val(data?.charges?.send?.percentage, 0);
      (document.getElementById('set-send-fixed')).value = val(data?.charges?.send?.fixed, 0);
      (document.getElementById('set-transfer-perc')).value = val(data?.charges?.transfer?.percentage, 0);
      (document.getElementById('set-transfer-fixed')).value = val(data?.charges?.transfer?.fixed, 0);
      (document.getElementById('set-res-bkash')).value = val(data?.reserve?.bkash, 0);
      (document.getElementById('set-res-nagad')).value = val(data?.reserve?.nagad, 0);
      (document.getElementById('set-pay-bkash')).value = val(data?.paymentNumbers?.bkash, '');
      (document.getElementById('set-pay-nagad')).value = val(data?.paymentNumbers?.nagad, '');
    }

    async function saveSettings() {
      const ref = doc(db, `artifacts/${appId}/admin_config/settings`);
      const payload = {
        charges: {
          send: {
            percentage: Number((document.getElementById('set-send-perc')).value) || 0,
            fixed: Number((document.getElementById('set-send-fixed')).value) || 0,
          },
          transfer: {
            percentage: Number((document.getElementById('set-transfer-perc')).value) || 0,
            fixed: Number((document.getElementById('set-transfer-fixed')).value) || 0,
          },
        },
        reserve: {
          bkash: Number((document.getElementById('set-res-bkash')).value) || 0,
          nagad: Number((document.getElementById('set-res-nagad')).value) || 0,
        },
        paymentNumbers: {
          bkash: String((document.getElementById('set-pay-bkash')).value || ''),
          nagad: String((document.getElementById('set-pay-nagad')).value || ''),
        },
      };
      await updateDoc(ref, payload).catch(async (e)=>{
        // If doc doesn't exist, set it
        await setDoc(ref, payload, { merge: true });
      });
    }

    function initSettingsPanel() {
      const btnR = document.getElementById('settings-refresh');
      const btnS = document.getElementById('settings-save');
      if (btnR) btnR.addEventListener('click', () => loadSettings());
      if (btnS) btnS.addEventListener('click', async () => { await saveSettings(); });
    }

    // Initialize panels (standalone)
    async function initPanels() {
      // Always use standalone renderers
      await loadCashFallback();
      await loadTournamentFallback();
      initUserSearchPanel();
      await loadSettings();
      initSettingsPanel();
      // Wire refresh buttons
      const r1 = document.getElementById('fb-refresh-cash');
      if (r1) r1.addEventListener('click', loadCashFallback);
      const r2 = document.getElementById('fb-refresh-t');
      if (r2) r2.addEventListener('click', loadTournamentFallback);
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = '/login'; return; }
      try {
        const uref = doc(db, `artifacts/${appId}/users/${user.uid}`);
        const snap = await getDoc(uref);
        const isAdmin = snap.exists() && !!snap.data().isAdmin;
        adminNameEl.textContent = snap.data()?.fullName || user.email || 'Admin';
        if (!isAdmin) { window.location.href = '/'; return; }
        setTab('cash');
        subscribeSidebarBadges();
        await initPanels();
        
        // Final optimization: warm up both panels after initial load
        setTimeout(() => {
          statusText.textContent = 'Both admin panels preloaded and ready';
        }, 3000);
      } catch (e) {
        console.error(e);
        window.location.href = '/login';
      } finally {
        loading.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
